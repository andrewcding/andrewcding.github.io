<!DOCTYPE html>
<html>


<head>
	<meta charset="utf-8">
	<title>BA Group Demographics Webapp</title>
	
	<!-- Import Bootstrap Library-->
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	
	<!-- Geocoder -->
	<script
	src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
	<link rel="stylesheet"
	href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css"
	type="text/css" />
	<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.0/mapbox-gl-draw.js"></script>
	
	<!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
	<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
	
	<!-- Turf.js-->
	<script src="https://npmcdn.com/@turf/turf@5.1.6/turf.min.js"></script>
	
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
	<script src="https://kit.fontawesome.com/055a8d9660.js" crossorigin="anonymous"></script>
	
	<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.0/mapbox-gl-draw.js"></script>
	<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.0/mapbox-gl-draw.css" type="text/css">	
	<!-- add html infront of body, add height: 100% to map -->
	<style>
		
		html, body {height: 100%; margin: 0; padding: 0; }
		#map {height: 100%; width: 100%; }
		
		.mapboxgl-popup {
			max-width: 400px;
			font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
		}
		
		/* Style for sidebar buttons  */
		#clicksidediv:hover {
			background-color: rgba(100, 100, 100, 0.5);
		}
		#sidediv1:hover {
			background-color: rgba(100, 100, 100, 0.5);
		}
		#sidediv2:hover {
			background-color: rgba(100, 100, 100, 0.5);
		}
		
		/* Adjust width of radius slider */
		.slider-width {
			width: 350px;
		}
		
		/* Location of coordinates of draggable point */
		.coord-info {
			position: absolute;
			bottom: 8px; left:100px;
			font-family: sans-serif;
			font-size: 12px;
			color: #ffffff;
			opacity: 0.8;
			text-shadow: 2px 2px 4	px #000000;
			font-family:Helvetica;
		}
		
		/* Location of geocoder */
		.geocoder {
			position: absolute;
			left: 35px;
			top: 25px;
			z-index: 200;
		}
		
		/* Location of adv info */
		.panel-bottom {
			position: absolute;
			bottom: 25px;		
		}
		
		/* Density Legend */
		.heatmap_legend {
			background-color: #fff;
			border-radius: 3px;
			bottom: 40px;
			box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
			font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
			padding: 10px;
			position: absolute;
			left: 15px;
			z-index: 1;
		}

		.heatmap_legend h4 {
			margin: 0 0 5px;
		}
		.heatmap_legend div span {
			border-radius: 50%;
			display: inline-block;
			height: 10px;
			margin-right: 6px;
			width: 10px;
		}
		
		/* Small Rectangle to Display Population */
		#rcorners1 {
			border-radius: 25px;
			background: #261996;
			padding: 20px; 
			width: 300px;
			height: 100px;  
		}
		
		/* Radio Buttons (side by side) */
		.radio-btns input[type="radio"]{
			display: inline-block;
			vertical-align: baseline;
			margin-left: 20px;
		}
		
		.radio-btns label {
			display: inline-block;
			vertical-align: baseline;
			margin-left: 5px;
			padding-left: 5px;
		}

		/* Buttons to switch between modes */
		.button-9 {
			appearance: button;
			backface-visibility: 'hidden';
			background-color: #405cf5;
			border-radius: 6px;
			border-width: 0;
			box-shadow: rgba(50, 50, 93, .1) 0 0 0 1px inset,rgba(50, 50, 93, .1) 0 2px 5px 0,rgba(0, 0, 0, .07) 0 1px 1px 0;
			box-sizing: border-box;
			color: #fff;
			cursor: pointer;
			display: inline;
			font-size: 100%;
			float: left;
			height: 44px;
			line-height: 1.25;
			margin: 12px 0 10;
            margin-right: 40px;
			outline: none;
			overflow: hidden;
			padding: 0 5px;
			position: relative;
			text-align: center;
			transition: all .2s,box-shadow .08s ease-in;
			width: 150px;
          
		}
		
		/* Smaller buttons for Draw Mode */
		.button-small {
			font-size: 80%;
			height: 35px;
			width: 120px;
			margin: 12px 13 10;
		}
		
		.button-9:disabled {
			cursor: default;
		}
		
		.button-9:focus {
			box-shadow: rgba(50, 50, 93, .1) 0 0 0 1px inset, rgba(50, 50, 93, .2) 0 6px 15px 0, rgba(0, 0, 0, .1) 0 2px 2px 0, rgba(50, 151, 211, .3) 0 0 0 4px;
		}
		
		/* Button Container to put stuff under it on next line */
		.button-container {
			/* Add this wrapper div around the buttons */
			display: flex;
			flex-wrap: wrap;
			margin-bottom: 20px;
		}
		
	</style>
</head>

<body>
			
	<div class="container-fluid" style="height: 100%; display: flex; flex-direction: column; padding:0;">
		
		<div class="container-fluid" style="padding: 0;">
			<nav class="navbar navbar-dark" style="background: #cd3627;">
                <a class="navbar-brand" href="/">
                    <img src="https://bagroup.app/BA-legs-icon-a.png" width="30" height="30" class="d-inline-block align-top" alt="">
                    &nbsp; BA Group &nbsp; <span>|</span> &nbsp; <em>Movement in Urban Environments</em>
                </a>
                <ul class="navbar-nav ml-auto mr-4" style="display: inline-block;">
                        <li class="nav-item mr-3" style="display: inline-block;">
                            <a class="nav-link" data-toggle="modal" data-target="#ReportBugModal" href="#">Report Bug</a>
                        </li>
                        <li class="nav-item mr-3" style="font-size: 1.25rem; line-height: 0; display: inline-block;"><a class="nav-link" href="#">|</a></li>
                    
                        <li class="nav-item" style="display: inline-block;"><a class="nav-link" href="#">Login</a></li>
                    
                </ul>
            </nav>
		</div>
		
		<div class="row" style="height: 100%; margin-right: 0; margin-left: 0; overflow: hidden;">
			
			<div id="colleft" class="col-11 col-fluid" style="padding-right: 0; padding-left: 0; flex: 0 0 97%; max-width: 97%;">
				<div class="container-fluid" style="padding:0; height: 100%; width: 100%; position: relative;" id='map'>
					<!-- Geocoder -->
					<div class="row">
						<div class="col-4 col-fluid">
							<div id='geocoder' class='geocoder' style="height:100%"></div>
						</div>
						<div class="col-5 col-fluid"></div>
						<div class="col-3 col-fluid"></div>
					</div>
					<div class="row">
						<div class="col-4 col-fluid"></div>
						<div class="col-6 col-fluid"></div>
						<div class="col-2 col-fluid"> </div>
					</div>
				</div>
			</div>
			
			<div id="colright" class="col-1 col-fluid" style="background-color:#ffffff; height: 100%; padding-right: 0px; padding-left: 0px; flex: 0 0 3%; max-width: 3%;">
				<div class="container-fluid" id="SegInfo" style="height: 100%; display: flex; flex-direction: column; padding:0; flex-wrap: nowrap;">
					<div class="row" style="height:100%; margin-right: 0; margin-left: 0;">
						
						<div id="colrightleft" class="col-6 col-fluid" style="border-right-style:solid; border-right-width:thin; border-right-color:grey; height:100%; flex: 0 0 100%; max-width: 100%; padding-right: 0px; padding-left: 0px;">
							<div class="container-fluid" style="height: 100%; display: flex; flex-direction: column; padding:0; flex-wrap: nowrap;">
								<div id="sidediv1" style="padding-bottom: 10px; margin-bottom: 5px; margin-top: 10px; font-size: 25px; text-align: center; border-bottom-style: solid; border-bottom-width: thin; border-bottom-color:lightgray; font-size: 25px; text-align: center;">
									<i class="fas fa-info-circle"></i>
								</div>
								<div id="sidediv2" style="font-size: 25px; text-align: center; margin-top: 10px; margin-bottom: 5px;">
									<i class="fas fa-search-location"></i>
								</div>
								<div id="filler" style="text-align: center; height: 90%;"></div>
								<div id="clicksidediv" style="font-size: 25px; text-align: center;">
									<i id="arrows" class="fas fa-angle-double-left"></i>
								</div>
							</div>
						</div>
						
						<div id="colrightright" class="col-6 col-fluid" style="flex-direction: column; display:none; background-color:#ffffff; height:100%; flex: 0 0 0%; max-width: 0%; padding-right: 0px; padding-left: 0px;">
							<div class="container-fluid"
							style="height: 100%; display: flex; flex-direction: column; padding:0; flex-wrap: nowrap;">
							<div class="row" style="height:100%; margin-right: 0; margin-left: 0;">
								<!-- FIRST TAB -->
								<div id="infotab" class="col-3 col-fluid" style="flex-direction: column; display:none; background-color:#ffffff; height:100%; flex: 0 0 100%; max-width: 100%; padding-right: 0px; padding-left: 0px;overflow-y:auto;">
									<div class="modal-header">
										<h3 class="modal-title">BA Group Demographics Webapp</h3>
									</div>
									<div class="modal-body">
										<h5> Welcome to the Demographics Page on the BA Group Web App.</h5>
										<p class="pt-4 mb-1">On this webapp, you can obtain population counts in a specified area using three different methods. <br><br>
											<b>Travel Reach:</b> Finds population within a travel reach around a point based on traffic at the current time, given a travel time and transportation mode. <br>
											<b>Buffer:</b> Finds population within a linear buffer around a point. <br>
											<b>Draw:</b> Finds population within a drawn polygon by the user.</p>
										<p class="pt-4 mb-1"> Whenever the buffer or polygon is created or updated, the total population counts will be automatically updated. <br><br>

											To create an isochrone, select the <b>Travel Reach</b> button and drag the point around to move the site. Select the travel time and transportation mode using the radio buttons on the right. <br><br>
											
											To create a buffer, select the <b>Buffer</b> button and drag the point to desired location. Adjust the radius of the buffer using the slider on the right. <br><br>
											
											To create a polygon, click the <b>Draw</b> button and select vertices for the polygon. Double-click or press enter to finish the polygon. Once the polygon is created, click once outside the polygon to pan the map. To edit the polygon, click once inside the polygon to move it, and click another time to edit its vertices. <br><br>
											
											Additional polygons can be created by clicking the <b>New Polygon</b> button, and a new polygon can be created using the aformentioned instructions. To delete all polygons, click the <b>Clear Polygons</b> button.<br><br>
											
											To obtain additional information, click the <b>Show Advanced Info</b> box, which gives additional information regarding area, density, and information on the Dessemination Areas. Dessemination areas can be selected by clicking them on the map. A selected dessemination will have a cyan outline.</p>
										<h6 class="pt-4">Developed by Andrew Ding.</h6>
										<br>
									</div>
								</div>
								<!-- SECOND TAB -->
								<div id="locationtab" class="col-3 col-fluid" style="flex-direction: column; display:none; background-color:#ffffff; height:100%; flex: 0 0 100%; max-width: 100%; padding-right: 0px; padding-left: 0px;overflow-y:auto;">
									<div class="modal-header">
										<h3 class="modal-title">Population</h3>
									</div>
									<div class="modal-body">
										<!-- Mode Buttons  -->
										<div class="button-container">
											<button class="button-9" role="button" id="IsochroneButton">Travel Reach</button>
											<button class="button-9" role="button" id="BufferButton">Buffer</button>
											<button class="button-9" role="button" id="DrawButton">Draw</button>	
										</div>

										<hr>
										
										<!-- Buffer Slider -->
										<div class="slidecontainer" id="buffer_slider">
											<h5>Buffer Radius: <span id="demo"></span> km</h5>
											<input type="range" min="1" max="100" value="10" id="myRange" class="slider-width">
										</div>
										
										<!-- Draw Mode Buttons -->
										<div id="delete_polygons">
											<button class="button-9 button-small" type="button" onclick="
											draw.changeMode('draw_polygon'); 
											isDrawModeActive = true;
											clickable = 3;
											map.getCanvas().style.cursor = 'crosshair';">New Polygon</button>


											<button class="button-9 button-small" type="button" onclick="
											draw.deleteAll(); 
											draw.changeMode('draw_polygon'); 
											isDrawModeActive = true;
											clickable = 3; 
											document.getElementById('totPOP').innerHTML = '<strong>Draw a polygon to get<br>a population count</strong><br>'; 
											map.getCanvas().style.cursor = 'crosshair';
											map.getSource('point_raster_source').setData({
												type: 'FeatureCollection',
												features: []
											});">Clear Polygons</button>
											<br>
										</div>
										
										<!-- Isochrone Settings (time) -->
										<div class="radio-btns" id='isochrone_time'>
											<h5>Travel Time:</h5>

												<input type="radio" id="15Mins" value="15" name="TTime" v-model="role" checked>
												<label for="15Mins">15 Minutes</label>

												<input type="radio" id="30Mins" value="30" name="TTime" v-model="role">
												<label for="30Mins" class="work-label">30 Minutes</label>

												<input type="radio" id="45Mins" value="45" name="TTime" v-model="role">
												<label for="45Mins">45 Minutes</label>

										</div>
										<br>

										<!-- Isochrone Settings (travel mode) -->
										<div class="radio-btns" id='isochrone_mode'>
											<h5>Travel Mode:</h5>

												<input type="radio" id="Walking" value="walking" name="TMode" v-model="role">
												<label for="Walking">Walking</label>

												<input type="radio" id="Cycling" value="cycling" name="TMode" v-model="role">
												<label for="Cycling">Cycling</label>

												<input type="radio" id="Driving" value="driving-traffic" name="TMode" v-model="role" checked>
												<label for="Driving">Driving (based on live traffic)</label>
											
										</div>
										<hr>

										<!-- Layer filters -->
										<h5>Layer Filters</h5>
										<div class="custom-control custom-checkbox pl-6">
											<input type="checkbox" class="custom-control-input" id="switch2" checked>
											<label class="custom-control-label" for="switch2">Toronto Dissemination Area Polygons</label>	
										</div>
										<div class="custom-control custom-checkbox pl-6">
											<input type="checkbox" class="custom-control-input" id="switch5">
											<label class="custom-control-label" for="switch5">Hide Density</label>					
										</div>
										<div class="custom-control custom-checkbox pl-6" id="shape_toggle">
											<input type="checkbox" class="custom-control-input" id="switch3" checked>
											<label class="custom-control-label" for="switch3"><span id='toggle_label'></span></label>
										</div>
										<div class="custom-control custom-checkbox pl-6">
											<input type="checkbox" class="custom-control-input" id="switch4">
											<label class="custom-control-label" for="switch4">Population Raster</label>		
										</div>	

										<h6 class="pt-4">Change basemap:</h6>
										<div id="basemaps">
											<input id="streets-basemap-dark" type="radio" name="rtoggle"
												value="streets-dark" checked="checked" />
											<label for="streets-basemap-dark">Streets (dark)</label>
											<input id="streets-basemap-light" type="radio" name="rtoggle"
												value="streets" />
											<label for="streets-basemap-light">Streets (light)</label>
											<input id="satellite-basemap" type="radio" name="rtoggle"
												value="satellite" />
											<label for="satellite-basemap">Satellite</label>
										</div>


										<hr>
										<div id="rcorners1"><span style="color:white;" id='totPOP'></span></div>
										
										<div id="advancedinfo" style="display:none">
											
											<!-- Population Information -->
											<h4>Population Information</h4>
											<div><strong>Raster Point Count:</strong> <span id='count'></span></div>
											<div><strong>Polygon Area:</strong> <span id='bufferAREA'></span> km<sup>2</sup></div>
											<div><strong>Population Within Polygon:</strong> <span id='totPOP1'></span></div>
											<div><strong>Population Density Within Polygon:</strong> <span id='bufferDEN'></span> persons per km<sup>2</sup></div>
											<br>	
											<!-- Dessimination Information -->		
											<h4>Dessemination Area Information</h4>
											<div><span id='instruction'></span></div>
											<div><span id='name'></span></div>
											<div><span id='selectarea'></span></div>
											<div><span id='pop'></span></div>
											<div><span id='pop_density'></span></div>
											<div><span id='raspts'></span></div>
											<div><span id='popperpt'></span></div>
											<br>	
										</div>
										
										<!-- Advanced Info-->
										<div class="panel-bottom">
											<input id="advinfo" type="checkbox" />
											<label for="advinfo">Show Advanced Info</label>		
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	
	<script>
		// https://account.mapbox.com
		mapboxgl.accessToken = 'pk.eyJ1IjoiYWRyaWFubG9yaW9uIiwiYSI6ImNqeW5oc3ExbzBkdWczbGxmcDA0dmp6bmgifQ.XIK5Ql3kdrzZR3x14hAyrw';
		var map = new mapboxgl.Map({
			container: 'map', // container id
			style: 'mapbox://styles/adrianlorion/cjzd6g96m2to81cp9pq1vy4ip', // style URL
			center: [-79.406025, 43.669517], // starting position [lng, lat]
			zoom: 12, // starting zoom
			bearing: 0 // rotate
		});
		
		// Add geocoder
		var geocoder = new MapboxGeocoder({
			accessToken: mapboxgl.accessToken,
			mapboxgl: mapboxgl,
			placeholder: 'Location Search'
		});
		document.getElementById('geocoder').appendChild(geocoder.onAdd(map));
		
		// Add drawing functionality
		
		var draw = new MapboxDraw({
			displayControlsDefault: false,
			defaultMode: "simple_select",
			// Select which mapbox-gl-draw control buttons to add to the map.
			controls: {
				//polygon: true,
				//trash: true
			},
			styles: [    // polygon fill
			{
				"id": "gl-draw-polygon-fill",
				"type": "fill",
				"filter": ["all", ["==", "$type", "Polygon"], ["!=", "mode", "static"]],
				"paint": {
					"fill-color": "#34b1eb",
					"fill-outline-color": "#34b1eb",
					"fill-opacity": 0.1
				}
			},
			// polygon outline stroke
			// This doesn't style the first edge of the polygon, which uses the line stroke styling instead
			{
				"id": "gl-draw-polygon-stroke-active",
				"type": "line",
				"filter": ["all", ["==", "$type", "Polygon"], ["!=", "mode", "static"]],
				"layout": {
					"line-cap": "round",
					"line-join": "round"
				},
				"paint": {
					"line-color": "#34b1eb",
					"line-width": 3
				}
			},
			// polygon mid points
			{
				'id': 'gl-draw-polygon-midpoint',
				'type': 'circle',
				'filter': ['all',
				['==', '$type', 'Point'],
				['==', 'meta', 'midpoint']],
				'paint': {
					'circle-radius': 5,
					'circle-color': '#34b1eb'
				}
			},
			// vertex point halos
			{
				"id": "gl-draw-polygon-and-line-vertex-halo-active",
				"type": "circle",
				"filter": ["all", ["==", "meta", "vertex"], ["==", "$type", "Point"], ["!=", "mode", "static"]],
				"paint": {
					"circle-radius": 7,
					"circle-color": "#FFF"
				}
			},
			// vertex points
			{
				"id": "gl-draw-polygon-and-line-vertex-active",
				"type": "circle",
				"filter": ["all", ["==", "meta", "vertex"], ["==", "$type", "Point"], ["!=", "mode", "static"]],
				"paint": {
					"circle-radius": 5,
					"circle-color": "#0356fc",
				}
			},]
		});
		
		map.on('load', async () => {
			
			// ADD BASEMAP TOGGLE
			// Toggle basemaps
			var street_dark_basemap = "mapbox://styles/adrianlorion/cjzd6g96m2to81cp9pq1vy4ip"
			var street_light_basemap = "mapbox://styles/adrianlorion/cjyexmd9m4ee21coeptyy4581"
			var satellite_basemap = "mapbox://styles/mapbox/satellite-v9"
			var baseLayers = [
			{
				label: 'Streets',
				id: 'mapbox://styles/adrianlorion/cjyexmd9m4ee21coeptyy4581'
			},
			{
				label: 'Streets-Dark',
				id: 'mapbox://styles/adrianlorion/cjzd6g96m2to81cp9pq1vy4ip'
			},
			{
				label: 'Satellite',
				id: 'mapbox://styles/mapbox/satellite-v9'
			}];
			
			var basemapList = document.getElementById('basemaps');
			var inputs = basemapList.getElementsByTagName('input');
			
			function switchBasemap(layer) {
				var layerId = layer.target.id;
				
				if (layerId == "streets-basemap-light" & map.getStyle().name != 'Light-Edited') {
					map.setStyle(street_light_basemap);
					map.on('style.load', function () {
						load_map();	
					});
				}
				if (layerId == "streets-basemap-dark" & map.getStyle().name != 'Dark-Edited') {
					map.setStyle(street_dark_basemap);
					map.on('style.load', function () {
						load_map();
					});
				}
				if (layerId == "satellite-basemap" & map.getStyle().name != 'Mapbox Satellite') {
					map.setStyle(satellite_basemap);
					map.on('style.load', function () {
						load_map();
					});
				}
			}
			for (var i = 0; i < inputs.length; i++) {
				inputs[i].onclick = switchBasemap;
			}

			// ADD ISOCRONE 
			
			// Create constants to use in getIso()
			const urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';

			// Create a function that sets up the Isochrone API query then makes an fetch call
			async function getIso(lon, lat, minutes, mode) {
				const query = await fetch(
				`${urlBase}${mode}/${lon},${lat}?contours_minutes=${minutes}&polygons=true&access_token=${mapboxgl.accessToken}`,
				{ method: 'GET' }
				);
				
				const data = await query.json();
				return data;
			}
			
			// POPULATION RASTER POINTS
			const pop_raster = await fetch(
			'https://andrewding.ca/jsons/TorontoPointRaster.geojson'
			);
			const pop_raster_geojson = await pop_raster.json();
			
			
			
			// DA DENSITY ----------------------------------------------------- START
			
			function add_da_density(){

				map.addSource("TO_DA_Source", {
				"type": "geojson",
				"data": "https://andrewding.ca/jsons/TorontoDAPolygons.geojson"
			});

				document.getElementById('instruction').innerHTML = '<strong>Please Click on a Dissemination Area</strong>'
				document.getElementById('name').innerHTML = '';
				document.getElementById('raspts').innerHTML = '';
				document.getElementById('selectarea').innerHTML = '';
				document.getElementById('pop').innerHTML = '';
				document.getElementById('popperpt').innerHTML = '';
				document.getElementById('pop_density').innerHTML = '';
				
				map.addLayer(
				{
					'id': 'da_density',
					'type': 'fill',
					'source': 'TO_DA_Source',
					'layout': {
						'visibility': 'visible'
					},
					'paint': {
						'fill-color':
						['interpolate',
					['linear'],
					['/', ['get', 'pop'], ['/', ['get', 'Shape_Area'], 1000000]],
					0,
					'#fff2b2',
					2500,
					'#fecc5c',
					10000,
					'#fd8d3c',
					25000,
					'#f03b20',
					100000,
					'#bd0026']
				}
			});
			
			map.addLayer({
				'id': 'da_density_line',
				'type': 'line',	
				'source': 'TO_DA_Source',
				'layout': {
					'visibility': 'visible'
				},
				'paint': {
					'line-color': '#FFFFFF',
					'line-width': [
					'interpolate', 
					['linear'], 
					['zoom'],
					10, 0.4, 
					19, 1
					]
				}
			});
			map.addLayer({
				'id': 'da_density_line_select',
				'type': 'line',	
				'source': 'TO_DA_Source',
				'layout': {
					'visibility': 'visible'
				},
				'paint': {
					'line-color': '#4de2dc',
					'line-width': ["case",
					["boolean", ["feature-state", "hover"], false],
					4.5,
					0
					]
				}
			});
			}
			
			add_da_density()
			
			// DA DENSITY END
			
			// TORONTO DA POLYGONS ----------------------------------------------------- START
			function add_da_hollow(){
				map.addLayer({
					'id': 'TO_DA_Fill_Layer',
					'type': 'fill',
					'source': 'TO_DA_Source',
					'layout': {
						'visibility': 'none'
					},
					'paint': {
						"fill-color": "#FFFFFF",
						"fill-opacity": 0.1
					}
				});
				map.addLayer({
					'id': 'TO_DA_Border_Layer',
					'type': 'line',	
					'source': 'TO_DA_Source',
					'layout': {
						'visibility': 'none'
					},
					'paint': {
						'line-color': '#FFFFFF',
						'line-width': [
						'interpolate', 
						['linear'], 
						['zoom'],
						10, 0.4, 
						19, 1
						]
					}
				});
				map.addLayer({
					'id': 'TO_DA_Border_Layer_select',
					'type': 'line',	
					'source': 'TO_DA_Source',
					'layout': {
						'visibility': 'none'
					},
					'paint': {
						'line-color': '#4de2dc',
						'line-width': ["case",
						["boolean", ["feature-state", "hover"], false],
						4.5,
						0
						]
					}
				});
			}
			
			add_da_hollow()

			// TORONTO DA POLYGONS END
			
			// SET UP CHANGING BETWEEN MODES ----------------------------------------------------- START
			
			// isochrone enabled
			document.getElementById('IsochroneButton').onclick = function() {

				if (polymode == 3) {
					isDrawModeActive = false;
					radius_marker.addTo(map);
					draw.trash();
					draw.deleteAll();
					map.getCanvas().style.cursor = '';
					clickable = 1;
				}
				polymode = 1;

				

				document.getElementById('toggle_label').innerHTML = 'Travel Reach'

				if (document.getElementById("switch3").checked == false) {
					
					// recheck hide buffer
					document.getElementById("switch3").checked = true;
					radius_marker.addTo(map);
				} 

				circlepoints_update()


				toggleLayer(true, "isoLayer")
				toggleLayer(true, "isoLayer_line")
				toggleLayer(false, "circle_line_layer")
				toggleLayer(false, "circle_fill_layer")

				// hide controls
				document.getElementById("isochrone_time").style.display = "flex"
				document.getElementById("isochrone_mode").style.display = "flex"

				document.getElementById("buffer_slider").style.display = "none"
				
				document.getElementById("delete_polygons").style.display = "none"

				document.getElementById("shape_toggle").style.display = "block"
			};
			
			//buffer enabled
			document.getElementById('BufferButton').onclick = function() {

				if (polymode == 3) {
					isDrawModeActive = false;
					radius_marker.addTo(map);
					draw.trash();
					draw.deleteAll();
					map.getCanvas().style.cursor = '';
					clickable = 1;
				}

				polymode = 2;
				
				
		
				document.getElementById('toggle_label').innerHTML = 'Buffer'
				
				
				circlepoints_update()
				toggleLayer(false, "isoLayer")
				toggleLayer(false, "isoLayer_line")
				toggleLayer(true, "circle_line_layer")
				toggleLayer(true, "circle_fill_layer")

				// hide controls
				document.getElementById("isochrone_time").style.display = "none"
				document.getElementById("isochrone_mode").style.display = "none"

				document.getElementById("buffer_slider").style.display = "block"

				document.getElementById("delete_polygons").style.display = "none"

				document.getElementById("shape_toggle").style.display = "block"
			}; 

			// draw enabled
			document.getElementById('DrawButton').onclick = function() {

				// only create this message if coming from another polygon mode
				if (polymode != 3) {
					document.getElementById('totPOP').innerHTML = '<strong style="color:white;">Draw a polygon to get<br>a population count</strong><br>';
					
					map.getSource('point_raster_source').setData({
						type: 'FeatureCollection',
						features: []
					});
				}

				
				polymode = 3;
				
				draw.changeMode('draw_polygon');
				isDrawModeActive = true;
				clickable = 3;
				map.getCanvas().style.cursor = "crosshair";
				
				map.moveLayer('gl-draw-polygon-fill.cold');
				map.moveLayer('gl-draw-polygon-stroke-active.cold');
				map.moveLayer('gl-draw-polygon-midpoint.cold');
				map.moveLayer('gl-draw-polygon-and-line-vertex-halo-active.cold');
				map.moveLayer('gl-draw-polygon-and-line-vertex-active.cold');
				map.moveLayer('gl-draw-polygon-fill.hot');
				map.moveLayer('gl-draw-polygon-stroke-active.hot');
				map.moveLayer('gl-draw-polygon-midpoint.hot');
				map.moveLayer('gl-draw-polygon-and-line-vertex-halo-active.hot');
				map.moveLayer('gl-draw-polygon-and-line-vertex-active.hot');
				
				// hide other layers
				radius_marker.remove();
				toggleLayer(false, "isoLayer")
				toggleLayer(false, "isoLayer_line")
				toggleLayer(false, "circle_line_layer")
				toggleLayer(false, "circle_fill_layer")

				document.getElementById("isochrone_time").style.display = "none"
				document.getElementById("isochrone_mode").style.display = "none"

				document.getElementById("buffer_slider").style.display = "none"

				document.getElementById("delete_polygons").style.display = "block"

				document.getElementById("shape_toggle").style.display = "none"
				
			}; 
			
			// SET UP CHANGING BETWEEN MODES END

			// GET USER INPUT FROM SIDE BAR ----------------------------------------------------- START

			// grab slider value, update circle with new radius
			var slider = document.getElementById("myRange");
			var output = document.getElementById("demo");
			output.innerHTML = slider.value/4;
			
			slider.oninput = function() {
				output.innerHTML = this.value/4;
				circle_radius = this.value/4;
				circlepoints_update();
			}
			

			// change traveltime based on radio buttons
			var traveltime = 15
			
			if (document.querySelector('input[name="TTime"]')) {
				document.querySelectorAll('input[name="TTime"]').forEach((elem) => {
					elem.addEventListener("change", function(event) {
						traveltime = event.target.value;
						circlepoints_update();
					});
				});
			}
			
			// change travel mode based on radio buttons
			var travelmode = 'driving-traffic'
			
			if (document.querySelector('input[name="TMode"]')) {
				document.querySelectorAll('input[name="TMode"]').forEach((elem) => {
					elem.addEventListener("change", function(event) {
						travelmode = event.target.value;
						circlepoints_update();
					});
				});
			}
			
			// GET USER INPUT FROM SIDE BAR END
			
			
			// INTIALIZE WHAT IS SHOWN ON SIDEBAR ----------------------------------------------------- START
			
			// INITIALIZE POLYGON MODE
			// 1 = isochrone
			// 2 = buffer
			// 3 = draw
			
			var polymode = 1;

			// intialize layer toggle label as Travel Reach
			document.getElementById('toggle_label').innerHTML = 'Travel Reach'
			
			// initialize toggle features to be for isochrone
			document.getElementById("isochrone_time").style.display = "flex"
			document.getElementById("isochrone_mode").style.display = "flex"
			
			document.getElementById("buffer_slider").style.display = "none"
			document.getElementById("delete_polygons").style.display = "none"
			
			// INTIALIZE WHAT IS SHOWN ON SIDEBAR END
			
			// DRAGGABLE MARKER ----------------------------------------------------- START
			var radius_marker = new mapboxgl.Marker({
				draggable: true
			})
			.setLngLat([-79.406025, 43.669517]);
			document.getElementById('coords').innerText = '43.669517, -79.406025';
			
			//updates current coordinates of marker
			function onDragEnd() {
				const lngLat = radius_marker.getLngLat();
				var round_lat = Math.round(lngLat.lat * 1000000) / 1000000
				var round_lng = Math.round(lngLat.lng * 1000000) / 1000000
				document.getElementById('coords').innerText = `${round_lat}, ${round_lng}`;
				sidedivsize_toggle(sdiv2, sdiv1);
			}
			
			// adds radius marker to map
			radius_marker.addTo(map);
			
			// initialize radius to current slider value, and generate buffer circle
			var circle_radius = slider.value/4;
			var circle_centre = [radius_marker.getLngLat().lng, radius_marker.getLngLat().lat];
			var circle = turf.circle(circle_centre, circle_radius);
			
			// intialize features to be used w turf js
			var pop_within_circle = {
				type: "FeatureCollection",
				features: [],
			};
			
			// function to change pop information / update layer based on isochrone
			async function getAndProcessIso(lon, lat, minutes, mode) {
					
					isocrone_poly = await getIso(lon, lat, minutes, mode);
					
					// update isochrone layer
					map.getSource('iso').setData(isocrone_poly);

					// determine points within layer
					pop_within_circle = turf.pointsWithinPolygon(pop_raster_geojson, isocrone_poly);
					
					// update info on feature count
					count_raster_points = pop_within_circle.features.length;
					
					// update total population
					total_population = 0
					buffer_features = pop_within_circle.features;
					for (let i = 0; i < count_raster_points; i++) {
						total_population += buffer_features[i].properties.PopulationPerPoint; 
					}
					
					// update sidebar metrics
					final_count = count_raster_points.toLocaleString("en-US");
					final_pop = Math.round(total_population).toLocaleString("en-US");
					buff_AREA = turf.area(isocrone_poly) * 0.000001
					buff_AREA_round = Math.round(buff_AREA * 100)/100 // to round to two decimal places
					density = Math.round(total_population/buff_AREA)
					document.getElementById('count').innerText = final_count;
					document.getElementById('totPOP').innerHTML = '<strong style="color:white;">Population Within Travel Reach:</strong><br>' + final_pop;
					document.getElementById('totPOP1').innerText = final_pop;
					document.getElementById('bufferDEN').innerText = density.toLocaleString("en-US");
					document.getElementById('bufferAREA').innerText = buff_AREA_round.toLocaleString("en-US");
					
					map.moveLayer('isoLayer', 'circle_line_layer');
					map.moveLayer('isoLayer_line', 'circle_line_layer');
					map.getSource("point_raster_source").setData(pop_within_circle);
				}
			
			// intialize isocrone
			getAndProcessIso(radius_marker.getLngLat().lng, radius_marker.getLngLat().lat, traveltime, travelmode);	
			
			
			// add layers to map
			addLayers_circle()
			addLayers_population_raster()
			add_isocrone_layer()
			
			// when marker is dragged, rerun these functions
			radius_marker.on('dragend', onDragEnd);
			radius_marker.on('dragend', circlepoints_update);
			
			// updates buffer circle, and points within buffer circle
			function circlepoints_update() {
				circle_centre = [radius_marker.getLngLat().lng, radius_marker.getLngLat().lat];
				circle = turf.circle(circle_centre, circle_radius);
				
				//update isochrone
				if (polymode == 1) {
					getAndProcessIso(radius_marker.getLngLat().lng, radius_marker.getLngLat().lat, traveltime, travelmode);	
				}

				// update buffer
				if (polymode == 2) {
					pop_within_circle = turf.pointsWithinPolygon(pop_raster_geojson, circle);
					
					// update info on feature count
					count_raster_points = pop_within_circle.features.length;
					
					// update total population
					total_population = 0
					buffer_features = pop_within_circle.features;
					for (let i = 0; i < count_raster_points; i++) {
						total_population += buffer_features[i].properties.PopulationPerPoint; 
					}
					
					// update sidebar metrics
					final_count = count_raster_points.toLocaleString("en-US");
					final_pop = Math.round(total_population).toLocaleString("en-US");
					buff_AREA = turf.area(circle) * 0.000001
					buff_AREA_round = Math.round(buff_AREA * 100)/100
					density = Math.round(total_population/buff_AREA)
					document.getElementById('count').innerText = final_count;
					document.getElementById('totPOP').innerHTML = '<strong style="color:white;">Population Within Buffer:</strong><br>' + final_pop;
					document.getElementById('totPOP1').innerText = final_pop;
					document.getElementById('bufferDEN').innerText = density.toLocaleString("en-US");
					document.getElementById('bufferAREA').innerText = buff_AREA_round.toLocaleString("en-US");
					
					// redraw items
					circle_update();
				}
			}
			
			// adds buffer circle to map
			function addLayers_circle() {
				
				map.addSource("circle_source", {
					'type': 'geojson',
					'data': circle
				});
				
				map.addLayer({
					'id': 'circle_line_layer',
					'type': 'line',
					'source': 'circle_source',
					'layout': {
						'visibility': 'none'
					},
					'paint':{
						'line-color': '#34b1eb',
						'line-width': 3,
					}
				});
				
				map.addLayer({
					'id': 'circle_fill_layer',
					'type': 'fill',
					'source': 'circle_source',
					'layout': {
						'visibility': 'none'
					},					
					'paint':{
						"fill-color": "#34b1eb",
						"fill-opacity": 0.3
					}
				});
			}
			
			// adds isochrone to map
			function add_isocrone_layer() {
				map.addSource('iso', {
					type: 'geojson',
					data: {
						type: 'FeatureCollection',
						features: []
					}
				});
				
				map.addLayer(
				{
					id: 'isoLayer',
					type: 'fill',
					source: 'iso',
					layout: {},
					paint: {
						"fill-color": "#34b1eb",
						"fill-opacity": 0.3
					}
				});
				
				map.addLayer(
				{
					id: 'isoLayer_line',
					type: 'line',
					source: 'iso',
					layout: {},
					paint :{
						'line-color': '#34b1eb',
						'line-width': 3,
					}
				});
				

			}
			
			// adds pop raster to map
			function addLayers_population_raster() {
				
				map.addSource("point_raster_source", {
					'type': 'geojson',
					'data': pop_within_circle
				});
				
				map.addLayer({
					'id': 'point_raster_layer',
					'type': 'circle',
					'source': 'point_raster_source',
					'layout': {
						'visibility': 'none'
					},
					'paint': {
						'circle-radius': 3,
						'circle-stroke-width': 0,
						'circle-color': '#000000', //'#999999',
						'circle-opacity': 1,
						'circle-stroke-color': '#ffffff'
					}
				})
				
			}
			
			
			// resets sources for map layers and updates their geometries/data
			function circle_update() {
				// update data sources (isochrone is updated inside getAndProcessIso instead of here)
				map.getSource("circle_source").setData(circle);
				map.getSource("point_raster_source").setData(pop_within_circle);

				// move the density layer to back of map
				map.moveLayer('da_density', 'circle_line_layer');
				map.moveLayer('da_density_line', 'circle_line_layer');
				map.moveLayer('da_density_line_select', 'circle_line_layer');
				
			}
			
			// DRAGGABLE MARKER END
			
			
			// DRAWN POLYGON ----------------------------------------------------- START

			// add drawn polgon to map
			map.addControl(draw);			
			
			// when polygon is created or updated, update population metrics
			map.on('draw.create', updateArea);
			map.on('draw.update', updateArea);
			
			function updateArea() {
				
				sidedivsize_toggle(sdiv2, sdiv1);
				
				// gets all of the polygons made
				const draw_polygon = draw.getAll();
				
				pop_within_poly = turf.pointsWithinPolygon(pop_raster_geojson, draw_polygon);
				
				// update info on feature count
				count_raster_points = pop_within_poly.features.length;
				
				// update total population
				total_population = 0
				buffer_features = pop_within_poly.features;
				for (let i = 0; i < count_raster_points; i++) {
					total_population += buffer_features[i].properties.PopulationPerPoint; 
				}
				
				// update sidebar metrics
				final_count = count_raster_points.toLocaleString("en-US");
				final_pop = Math.round(total_population).toLocaleString("en-US");
				poly_AREA = turf.area(draw_polygon) * 0.000001 //NOTE OVERLAPPING ARE WILL BE COUNTED TWICE
				poly_AREA_round = Math.round(poly_AREA * 100)/100
				density = Math.round(total_population/poly_AREA)
				document.getElementById('count').innerText = final_count;
				document.getElementById('totPOP').innerHTML = '<strong style="color:white;">Population Within Drawn Polygon:</strong><br>' + final_pop;
				document.getElementById('totPOP1').innerText = final_pop;
				document.getElementById('bufferDEN').innerText = density.toLocaleString("en-US");
				document.getElementById('bufferAREA').innerText = poly_AREA_round.toLocaleString("en-US");
				
				map.getSource("point_raster_source").setData(pop_within_poly);
				
			}
			
			// DRAWN POLYGON END
			
			// TOGGLE LAYERS FUNCTIONALITY ----------------------------------------------------- START
			function toggleLayer(isChecked, layer) {
				if (isChecked) {
					map.setLayoutProperty(layer, 'visibility', 'visible');
				} else {
					map.setLayoutProperty(layer, 'visibility', 'none');
				}
			}
			
			function toggleLegend(isChecked, legend) {
				if (isChecked) {
					document.getElementById(legend).style.display = "block";
				} else {
					document.getElementById(legend).style.display = "none";
				}
			}
			
			function applySwitches() {

				// toggle dissemination area
				document.getElementById('switch2').addEventListener('change', function () {

					var isChecked = this.checked;

					// turn off 'hide density' if its already on, and hide its layers
					if (document.getElementById('switch5').checked) {
						document.getElementById("switch5").checked = false;
						toggleLayer(false, "TO_DA_Fill_Layer");
						toggleLayer(false, "TO_DA_Border_Layer");
						toggleLayer(false, "TO_DA_Border_Layer_select")
					}

					// show layers and legend
					toggleLayer(isChecked, "da_density")
					toggleLayer(isChecked, "da_density_line")
					toggleLayer(isChecked, "da_density_line_select")
					toggleLegend(isChecked, 'popden-legend')
				});

				// toggle isochrone or buffer
				document.getElementById('switch3').addEventListener('change', function () {

					var isChecked = this.checked;
					
					//if mode is isochrone
					if (polymode == 1){
						toggleLayer(isChecked, "isoLayer")
						toggleLayer(isChecked, "isoLayer_line")
						
						if (isChecked) {
							radius_marker.addTo(map);
						} else {
							radius_marker.remove();
						}
					}
					
					// if mode is buffer
					if (polymode == 2){
						toggleLayer(isChecked, "circle_line_layer")
						toggleLayer(isChecked, "circle_fill_layer")
						
						if (isChecked) {
							radius_marker.addTo(map);
						} else {
							radius_marker.remove();
						}
					}					
				});

				// toggle population raster
				document.getElementById('switch4').addEventListener('change', function () {
					var isChecked = this.checked;
					toggleLayer(isChecked, "point_raster_layer")
				});

				// toggle non-pop density dissemination area
				document.getElementById('switch5').addEventListener('change', function () {
					var isChecked = this.checked;
					
					// if choropleth is checked, uncheck it and hide the layer
					if (document.getElementById('switch2').checked) {
						document.getElementById("switch2").checked = false;
						toggleLayer(false, "da_density")
						toggleLayer(false, "da_density_line")
						toggleLayer(false, "da_density_line_select")
						toggleLegend(false, 'popden-legend')
					}

					// show non-chropleth dissemination area
					toggleLayer(isChecked, "TO_DA_Fill_Layer")
					toggleLayer(isChecked, "TO_DA_Border_Layer")
					toggleLayer(isChecked, "TO_DA_Border_Layer_select")
				});

				// show/hide advanced info
				document.getElementById('advinfo').addEventListener('change', function () {
					var isChecked = this.checked;
					
					var info_box = document.getElementById("advancedinfo");
					var pop_box = document.getElementById("rcorners1");
					
					// If the checkbox is checked, display the output text
					if (document.getElementById('advinfo').checked){
						info_box.style.display = "block";
						pop_box.style.display = "none";
					} else {
						info_box.style.display = "none";
						pop_box.style.display = "block";
					}
				});
			}
			
			applySwitches();
			// TOGGLE LAYERS END
			
			
			// RELOAD LAYERS ON BASEMAP CHANGE
			function load_map(){
			
				// add da density choropleth and hollow
				add_da_density()
				add_da_hollow()
				
				// initialize pop raster
				var pop_within_circle = {
					type: "FeatureCollection",
					features: [],
				};
				
				// initialize buffer circle
				circle_centre = [radius_marker.getLngLat().lng, radius_marker.getLngLat().lat];
				var circle = turf.circle(circle_centre, circle_radius);
				
				// add isochrone and circle features and sources
				add_isocrone_layer()
				addLayers_circle() 
				addLayers_population_raster()
				
				// redraw
				circlepoints_update()
				
				if (polymode == 2){
					
					toggleLayer(false, "isoLayer")
					toggleLayer(false, "isoLayer_line")
					
					toggleLayer(true, "circle_line_layer")
					toggleLayer(true, "circle_fill_layer")
				}		
				
				map.moveLayer('da_density', 'circle_line_layer');
				map.moveLayer('da_density_line', 'circle_line_layer');
				map.moveLayer('da_density_line_select', 'circle_line_layer');
				
				map.moveLayer('isoLayer', 'circle_line_layer');
				map.moveLayer('isoLayer_line', 'circle_line_layer');

				if (polymode == 3){
					const draw_polygon = draw.getAll();
					pop_within_poly = turf.pointsWithinPolygon(pop_raster_geojson, draw_polygon);
					map.getSource("point_raster_source").setData(pop_within_poly);
					map.moveLayer('gl-draw-polygon-fill.cold');
					map.moveLayer('gl-draw-polygon-stroke-active.cold');
					map.moveLayer('gl-draw-polygon-midpoint.cold');
					map.moveLayer('gl-draw-polygon-and-line-vertex-halo-active.cold');
					map.moveLayer('gl-draw-polygon-and-line-vertex-active.cold');
					map.moveLayer('gl-draw-polygon-fill.hot');
					map.moveLayer('gl-draw-polygon-stroke-active.hot');
					map.moveLayer('gl-draw-polygon-midpoint.hot');
					map.moveLayer('gl-draw-polygon-and-line-vertex-halo-active.hot');
					map.moveLayer('gl-draw-polygon-and-line-vertex-active.hot');
				}
				

				if(document.getElementById('switch4').checked){
					toggleLayer(true, "point_raster_layer")
				}
				
				if(document.getElementById('switch5').checked){
				
					toggleLayer(true, "TO_DA_Fill_Layer")
					toggleLayer(true, "TO_DA_Border_Layer")
					toggleLayer(true, "TO_DA_Border_Layer_select")
				}
				
				if(!document.getElementById('switch3').checked){
					if (polymode == 1){
						toggleLayer(false, "isoLayer")
						toggleLayer(false, "isoLayer_line")
						radius_marker.remove();
						}
					
					// if mode is buffer
					if (polymode == 2){
						toggleLayer(false, "circle_line_layer")
						toggleLayer(false, "circle_fill_layer")
						radius_marker.remove();
					}					
				}

				if(!document.getElementById('switch2').checked){
					toggleLayer(false, "da_density")
					toggleLayer(false, "da_density_line")
					toggleLayer(false, "da_density_line_select")
					toggleLegend(false, 'popden-legend')
				}
				console.log(map.getStyle().layers);
			}
			
			
		});
		

		
		
		
		
		// Create a popup, but don't add it to the map yet.
		var popup = new mapboxgl.Popup({
			closeButton: false,
			closeOnClick: false
		});
		
		// POPUPS SIDEBAR/ON FEATURE ----------------------------------------------------- START
		
		// boolean to see if we are currently in draw mode or not
		let isDrawModeActive = false;

		// used to determine if we can select dissemination area on map or not
		let clickable = 1;
		
		// when drawmode changes
		map.on("draw.modechange", function (event) {
			if (event.mode === "draw_polygon" && polymode == 3) {
				isDrawModeActive = true;
				clickable = 3;
				map.getCanvas().style.cursor = "crosshair";
			} else {
				isDrawModeActive = false;
				clickable = 2;
				map.getCanvas().style.cursor = '';
			}
		});
		
		document.addEventListener("keydown", function (event) {
			if (event.keyCode === 13) {
				clickable = 1;
			}
		});
		
		// density choropleth mouseover
		map.on('mousemove', 'da_density', function (e) {
			if (!isDrawModeActive) {
				map.getCanvas().style.cursor = "pointer";
				
				var coordinates = e.features[0].geometry.coordinates.slice();
				var popup_pop = e.features[0].properties.pop;
				var popup_area = e.features[0].properties.Shape_Area;
				
				var pop_den = Math.round(popup_pop / (popup_area / 1000000)).toLocaleString("en-US");
				
				// Populate the popup and set its coordinates
				// based on the feature found.
				popup.setLngLat(e.lngLat).setHTML("<strong>Population Density: " +pop_den+ "/km<sup>2</sup></strong>").addTo(map);
			}
			
		});
		
		map.on('mouseleave', 'da_density', function () {
			if (!isDrawModeActive) {
				map.getCanvas().style.cursor = "";
			}
			popup.remove();
		});
		
		// population point mouseover
		map.on('mouseenter', 'point_raster_layer', function (e) {
			if (!isDrawModeActive) {
				map.getCanvas().style.cursor = "pointer";
				
				
				var coordinates = e.features[0].geometry.coordinates.slice();
				var description = e.features[0].properties.PopulationPerPoint;
				
				// Ensure that if the map is zoomed out such that multiple
				// copies of the feature are visible, the popup appears
				// over the copy being pointed to.
				while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
					coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
				}
				
				// Populate the popup and set its coordinates
				// based on the feature found.
				popup.setLngLat(coordinates).setHTML("<strong>" + description + "</strong>").addTo(map);
			}
			
		});
		
		
		map.on('mouseleave', 'point_raster_layer', function () {
			if (!isDrawModeActive) {
				map.getCanvas().style.cursor = "";
			}
			popup.remove();
		});
		
		
		var hoveredStateId = null;
		
		// select DA on choropleth
		map.on('click', 'da_density', function (e) {

			// makes it so when you double click to finish polygon, it doesnt select a DA
			if (clickable == 2) {
				clickable = 1;
			}
			else if (clickable == 1) {
				var location = e.features[0].properties.geo_code;
				var population = e.features[0].properties.pop;
				var raster_points = e.features[0].properties.Join_Count;
				var pop_per_pt = population / raster_points;
				var select_area = e.features[0].properties.Shape_Area;
				var display_area_sqm = Math.round(select_area);
				var display_area = Math.round((select_area / 1000000) * 100) / 100 // this is an extremely dumb way to round to two decimal places but it works
				var pop_den = Math.round(population / (select_area / 1000000));
				
				document.getElementById('instruction').innerHTML = ''
				document.getElementById('name').innerHTML = '<strong>Dissemination Area ID:</strong> ' + location;
				document.getElementById('raspts').innerHTML = '<strong>Number of Raster Points: </strong> ' + raster_points;
				document.getElementById('selectarea').innerHTML = '<strong>Area: </strong> ' + display_area_sqm + ' m<sup>2</sup> (' + display_area + ' km<sup>2</sup>)';
				
				if (population != null){
					document.getElementById('pop').innerHTML = '<strong>Total Population:</strong> ' + population.toLocaleString("en-US");
					document.getElementById('popperpt').innerHTML = '<strong>Population per Point: </strong> ' + pop_per_pt;
					document.getElementById('pop_density').innerHTML = '<strong>Population Density: </strong> ' + pop_den + ' persons per km<sup>2</sup>';
				}
				
				if (population == null){
					document.getElementById('pop').innerHTML = '<strong>Total Population:</strong> Undefined';
					document.getElementById('popperpt').innerHTML = '<strong>Population per Point: </strong> Undefined';
					document.getElementById('pop_density').innerHTML = '<strong>Population Density: </strong> Undefined';
				}
				
				//The Background Fill Will Become Darker When the Cursor Hovers Over
				if (e.features.length > 0) {
					if (hoveredStateId) {
						map.setFeatureState({
							source: 'TO_DA_Source',
							id: hoveredStateId
						}, {
							hover: false
						});
					}
					hoveredStateId = e.features[0].id;
					map.setFeatureState({
						source: 'TO_DA_Source',
						id: hoveredStateId
					}, {
						hover: true
					});
				}
				
				sidedivsize_toggle(sdiv2, sdiv1);
			}
			
		});
		
		// select DA on non chropleth DA
		map.on('click', 'TO_DA_Fill_Layer', function (e) {
			
			// makes it so when you double click to finish polygon, it doesnt select a DA
			if (clickable == 2) {
				clickable = 1;
			}
			else if (clickable == 1) {
				var location = e.features[0].properties.geo_code;
				var population = e.features[0].properties.pop;
				var raster_points = e.features[0].properties.Join_Count;
				var pop_per_pt = population / raster_points;
				var select_area = e.features[0].properties.Shape_Area;
				var display_area_sqm = Math.round(select_area);
				var display_area = Math.round((select_area / 1000000) * 100) / 100 // this is an extremely dumb way to round to two decimal places but it works
				var pop_den = Math.round(population / (select_area / 1000000));
				
				document.getElementById('instruction').innerHTML = ''
				document.getElementById('name').innerHTML = '<strong>Dissemination Area ID:</strong> ' + location;
				document.getElementById('raspts').innerHTML = '<strong>Number of Raster Points: </strong> ' + raster_points;
				document.getElementById('selectarea').innerHTML = '<strong>Area: </strong> ' + display_area_sqm + ' m<sup>2</sup> (' + display_area + ' km<sup>2</sup>)';
				
				if (population != null){
					document.getElementById('pop').innerHTML = '<strong>Total Population:</strong> ' + population.toLocaleString("en-US");
					document.getElementById('popperpt').innerHTML = '<strong>Population per Point: </strong> ' + pop_per_pt;
					document.getElementById('pop_density').innerHTML = '<strong>Population Density: </strong> ' + pop_den + ' persons per km<sup>2</sup>';
				}
				
				if (population == null){
					document.getElementById('pop').innerHTML = '<strong>Total Population:</strong> Undefined';
					document.getElementById('popperpt').innerHTML = '<strong>Population per Point: </strong> Undefined';
					document.getElementById('pop_density').innerHTML = '<strong>Population Density: </strong> Undefined';
				}
				
				//The Background Fill Will Become Darker When the Cursor Hovers Over
				if (e.features.length > 0) {
					if (hoveredStateId) {
						map.setFeatureState({
							source: 'TO_DA_Source',
							id: hoveredStateId
						}, {
							hover: false
						});
					}
					hoveredStateId = e.features[0].id;
					map.setFeatureState({
						source: 'TO_DA_Source',
						id: hoveredStateId
					}, {
						hover: true
					});
				}
				sidedivsize_toggle(sdiv2, sdiv1);
				
			}
			
		});
		
		// POPUPS SIDEBAR/ON FEATURE END
		
		var colrightsmall = true;
		var sdiv1 = document.getElementById("infotab");
		var sdiv2 = document.getElementById("locationtab");
		
		$("#clicksidediv").click(function () {
			sidedivsize();
		});
		
		$("#sidediv1").click(function () {
			sidedivsize_toggle(sdiv1, sdiv2);
		});
		
		$("#sidediv2").click(function() {
			sidedivsize_toggle(sdiv2, sdiv1);
		});
		
		
		
		function sidedivsize () {
			var left = document.getElementById("colleft");
			var right = document.getElementById("colright");
			var rightleft = document.getElementById("colrightleft");
			var rightright = document.getElementById("colrightright");
			var expand_button = document.getElementById("arrows");
			var sdiv1 = document.getElementById("infotab");
			var sdiv2 = document.getElementById("locationtab");
			
			
			if (colrightsmall) {
				colrightsmall = false;
				
				left.style.flex = "0 0 70%";
				left.style.maxWidth = "70%";
				right.style.flex = "0 0 30%";
				right.style.maxWidth = "30%";
				rightleft.style.flex = "0 0 10%";
				rightleft.style.maxWidth = "10%";
				rightright.style.flex = "0 0 90%";
				rightright.style.maxWidth = "90%";
				rightright.style.display = "flex";
				sdiv1.style.display = "flex";
				sdiv2.style.display = "none";
				expand_button.classList.remove("fa-angle-double-left");
				expand_button.classList.add("fa-angle-double-right");
			}
			
			else {
				colrightsmall = true;
				
				left.style.flex = "0 0 97%";
				left.style.maxWidth = "97%";
				right.style.flex = "0 0 3%";
				right.style.maxWidth = "3%";
				rightleft.style.flex = "0 0 100%";
				rightleft.style.maxWidth = "100%";
				rightright.style.flex = "0 0 0%";
				rightright.style.maxWidth = "0%";
				rightright.style.display = "none";
				sdiv1.style.display = "none";
				sdiv2.style.display = "none";
				expand_button.classList.remove("fa-angle-double-right");
				expand_button.classList.add("fa-angle-double-left");
			}
			
			var mapcanvas = document.getElementsByClassName("mapboxgl-canvas")[0];
			mapcanvas.style.width = '100%';
			map.resize();
		}
		
		
		function sidedivsize_toggle(open_div, close_div1) {
			var left = document.getElementById("colleft");
			var right = document.getElementById("colright");
			var rightleft = document.getElementById("colrightleft");
			var rightright = document.getElementById("colrightright");
			var expand_button = document.getElementById("arrows");
			
			if (colrightsmall) {
				colrightsmall = false;
				right.style.flex = "0 0 30%";
				right.style.maxWidth = "30%";
				left.style.flex = "0 0 70%";
				left.style.maxWidth = "70%";
				rightleft.style.flex = "0 0 10%";
				rightleft.style.maxWidth = "10%";
				rightright.style.flex = "0 0 90%";
				rightright.style.maxWidth = "90%";
				rightright.style.display = "flex";
				open_div.style.display = "flex";
				close_div1.style.display = "none";
				expand_button.classList.remove("fa-angle-double-left");
				expand_button.classList.add("fa-angle-double-right");
			}
			
			else {
				open_div.style.display = "flex";
				close_div1.style.display = "none";					
			}
			var mapcanvas = document.getElementsByClassName("mapboxgl-canvas")[0];
			mapcanvas.style.width = '100%';
			map.resize();
		}
		
		// Open Sidebar
		sidedivsize_toggle(sdiv1, sdiv2);
	</script>
	
	<!-- coord info on bottom left for draggable point -->
	<div class='coord-info'>
		<div><strong><span id='coords'></span></strong></div>
	</div>
	

	<!-- legend on bottom left for pop density choropleth -->
	<div id="popden-legend" class="heatmap_legend" style="display: block;">
		<h6><b>Legend</b></h6>
		<h7><b>Population Density by DA<br>DA, 2021</b></h7>
		<div><span style="background-color: #fff2b2"></span>&gt; 0 people/km<sup>2</sup></div>
		<div><span style="background-color: #fecc5c"></span>&gt; 2500 people/km<sup>2</sup></div>
		<div><span style="background-color: #fd8d3c"></span>&gt; 10000 people/km<sup>2</sup></div>
		<div><span style="background-color: #f03b20"></span>&gt; 25000 people/km<sup>2</sup></div>
		<div><span style="background-color: #bd0026"></span>&gt; 100000 people/km<sup>2</sup></div>
	</div>
	
</body>
</html>